import collections

# --- 1. Налаштування ---
ALPHABET = "абвгдеёжзийклмнопрстуфхцшщъыьэюя"
ALPHABET_MAP = {char: i for i, char in enumerate(ALPHABET)}
ALPHABET_LEN = len(ALPHABET)

IC_LANGUAGE = 0.0529  # Теоретичний IC для російської мови
MOST_FREQUENT_CHAR = 'о'  # Найчастіша літера (x*)
MAX_KEY_LENGTH_TO_CHECK = 30
OUTPUT_FILENAME = "3.txt"


def clean_text(text: str) -> str:
    """Приводить до нижнього регістру, видаляє все, крім літер."""
    text = text.lower()
    return "".join([char for char in text if char in ALPHABET_MAP])


def calculate_ic(text: str) -> float:
    """Обчислює індекс відповідності (IC) для тексту."""
    n = len(text)
    if n <= 1:
        return 0.0

    freqs = collections.Counter(text)
    ic_sum = sum(count * (count - 1) for count in freqs.values())
    return ic_sum / (n * (n - 1))


def vigenere_decrypt(ciphertext: str, key: str) -> str:
    """Розшифровує текст Віженера за ключем."""
    plaintext = ""
    key_len = len(key)
    if key_len == 0:
        return ""

    for i, char in enumerate(ciphertext):
        c_idx = ALPHABET_MAP[char]
        k_idx = ALPHABET_MAP[key[i % key_len]]
        p_idx = (c_idx - k_idx + ALPHABET_LEN) % ALPHABET_LEN
        plaintext += ALPHABET[p_idx]
    return plaintext


def get_probable_key(ciphertext: str, key_length: int) -> str:
    """Автоматично знаходить ключ, припускаючи y* -> 'о'."""
    key = ""
    x_star_idx = ALPHABET_MAP[MOST_FREQUENT_CHAR]

    for i in range(key_length):
        block = ciphertext[i::key_length]
        if not block:
            key += 'а'  # Заповнювач, якщо блок порожній
            continue
        try:
            y_star_char = collections.Counter(block).most_common(1)[0][0]
            y_star_idx = ALPHABET_MAP[y_star_char]
            k_idx = (y_star_idx - x_star_idx + ALPHABET_LEN) % ALPHABET_LEN
            key += ALPHABET[k_idx]
        except Exception:
            key += 'а'  # Заповнювач на випадок помилки
    return key


def main():
    """Головна логіка."""

    # !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    # !!! УВАГА: ВСТАВТЕ ВАШ ПОЧАТКОВИЙ ШИФРТЕКСТ СЮДИ
    # !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    ciphertext_raw = """
    еьбюятфхмпяякнпчццшявпрыумтчкктълвацхтжышэргущнныюкшяпьйтшюмвзщыэъвачьймучицъхцщьдерэхшълдунхтутс
ыэхыъибгмттэбгбптщныоасякдуццйпющоибаужеуацебаъпдвхцоюбхуюкыфйнбэнощюпыльыъшдяхнцюхктнкащовачцъб
тощечйщисъчятеюэюзшаърнчхшъфйтьккщиннчсуйгбощрчызхтюыкщдшощеаьшбнштщьцшчылуюмцзаънэюбыыеьучьма
юцщдтновььцртшъцыжыытекъстптщрхтфегоэзсссфажгьифюрньокяьхкъщяйэвъушешчърймуъолььрннхычшясыозщюътз
фычшябрылцбырдцюъкцюйупъууукояиьжууылуяъосятщпбашяптымиаашнпцапрнпъснмнвфпдшоцкыаоемяыщььешезтш
ьеоэтхтучмьжыаоемяыщььуляпъоцтмарцтыяпювчцлтпахячвдьцфтячаоъютъпешчфпаоепъдхшеетшяктьасяылшюбъыьыьо
епктхыжхкшнэсмешчмпчфюбалчоцомитцьцшыылущфнзъпцыеекылмщснмаццьжббшефюспкчърйбуяьбйзфйрсьцоауйакт
шъмлтрхтжаечоьоникъфиьвгмьоыйчаддчццфаойгпщсзмащыыщгодрвоьазаоныгшбцякуювдйъцыжпорерущиюпяцяьеъоьв
аякяъщнинуйдвхккпдвтйшдбькошэьосъпупбыпъэьуьизяытшжбъоьчуырндхкшдшбцпсоцомебыфвакэншафвоащцнфшьуй
ээьоюфхъжетщьпшъячсаьццщмпыкечоптгяцьзюиплуаъчдйъгуцшыэнтщъждяъгуюэшыуэысрягязрьяшчечуоеращцубыьцк
прэтпчдииныуыеыьырндхкхщатняшхруфтърьдшчцьмаъчйччшпгюпыейтсйрдпрьщюжыллбресгыкпдлкащъупуксэхещын
онцьщицяинфвюппэчцлвдйъццщччйжвоьпнършецухпиптщылъьнъщютрфказмзаяйхщдфойтэъдоаюупшатъехбгалъеномы
ццесрфтптуипеютпшфоцкнхсиьвбчшэыочсюгшцйабфюлньыерьнхкгютаэяэълябэрффщоьйтхсгньнщкбыуэншесрцъпихет
лйхьюфхзпярвжгтгечуялнфхфшьъцукйнцаецисъфъчомъоолдяхнъфдяьбтщфсыуицьюгерэйюмзкащгьдучжвтюоызериопхк
щэыкныптсркяпчоьыцшмддэрбббыащфьэтюьщичшухйкпрфдзюнзыйшцомпыюайешисцшстшццэтзйтщфвьъьдеыстмчяеь
вфещэлйщепафизжблйилйьаргчисыущцокыщыиянчшябьыэяэясснърыяшоойтысснгдрьфачйтфоьабтъцмгбмуоькътъгмяпя
шьыеяяцистърййакрвъыъеьдысовгшслужчиядшичжофькьцщемднфэцжнюыцьхуоаэхшэгпжеьучьмаюътьъьооцощизфршп
бюкыбтмътсвычтюуфьдпюъгяьяшшгыфбнкшмснгяшшцущюечдмэгеншофакжмтднепхтхффдкыейъфшявныьдуцплмйоак
аюдмаычбпчйхрягюткыхыуфььънздпцъьютрмъьшеееяткйбььбчьпокчсцмвцшэвъцъдяцымъзцшслтяцопчткыщцшаяшюлт
бянапцгпъьытсляферыргкпэццоепзыкчьэшряпюъясяычпдшхупкнътртщцкбучьяэмуелэлеьвевончовекъпипждйрэщьпедбн
шкхбхйккопапдаюпбеъъеъолчтфюъмвхкщзкшюазяюъмщачййшпеилбшичвяшпчптфнючящйфхкщлчсфпдвоцъщшмямшщ
яддяъцугжыашчухоачэннфсгужсопагьаиущгыюлфррамяисцьцмевьйьецтюиобторэодмтыдэньршньеиылмясяхтюжьюэбцо
акгчцъвдькрфюмяйашнлфепщщчьхпкаютшеетпвсрълыяыцьмуьйякщэяряыккбубцккщясйаэзьрдйшупыюртъъиъфънькпэъ
сдвтмтбшъооыуцакгюилщюжышцяоирдыфьфьчйжбуювдвыынвюжыефяфлнбэнощюйрхтгсгнгамжхжпяитпзяовыйеяекъб
шщпомчазсцыцйжощлвпчщнчьакпиитмяйтчеьфвьцфжнпокапизжбьшлщухнъыъифвапектшйтндычъвэтырьйхгпчончрлху
йкрзчдвдрмфшьрмэяюосчюкшьчтоашымлзаятъфтоьзъолардхлцфетевышъйжтщтчзешчитыфиюбэнмдуьциынныбштшьцж
шплхкеемъмяэцдьрецолтмъчылщчтщюеъснюйяцфвюппэьучьмтмчхвдфьоькэобчэатяущьичйхоааэцььхшхяъоюиктюдмгш
ърлчогакоъцпгбхьгпыфенбхщкцъканттвасоскклуыоощщксмеягусюхцмылчлзбюцлдугоыгцхсюфытъзцыьюыаоемяылшкш
чанкяыордызчббубахьооигчцъвдькыщюъпнвгршбухккшчэимеюынщбнюэюцгерьысвьгшашфоцвптжихетлйпшатеьэшрщ
ефэтщчцюьлтмъчьэкэнтшьеоэтхкюхпыуэгьалтюцхвяшыэмуьоюдъцъпйкюетяырнуыккяытлпшъъжддогьрыяюэыестсатщь
рэшывбызйпчфыхреканкягестънтыяпыьхялмнштълпежяллььааунъыжхкявчъмрсчъмпмучлпштсйрдпрьщюжылтяюимяис
ядуцрлшпеецъюъеэрфямпюфмдяякшыяшфвчаълыьыхкгбхмоплюодцххыжхпыкечэлтйнсфвцоопшецаоаскпмымоктнщисъ
эиыгбхьгтщмсыуихкггштлхфснзъфнцббуьотцшаюдърфыуфщыбцчбъгпцуцыоцйечвийээцмббмтяктвасодньпгпеэыоъдмтч
цзжбшаоьбылдяхншжъкшлчоцтнюаопггптрыъътпчъхшщдкъецхмкняыфзжущьаъудннгядщдбьцясьчосацхшдяеывшащил
тшибзчпякшяюитйамкуъчоибаъздюшзмдуговьялицдызмдугоыыкомдгяныбшицопышапдтхощлкыемуэьотэрребцылицосд
юикъфмкщеыкыогюнзьбыфьйфьюопнцмпэдьреьучьмаърыюбхкзшысижютхйябъцвчамцзъюкшщцшэикымпндыфэлешыэ
муьхтхсншбэбуйэаъбъэьштцтсокчорртхыффваауяшьнряшннцвцшпвышъндйъцнввъьбшщтемъмхтжымршыьюузфсихрък
энптсляюхцьшухукчйбгяэнтььэчотштфлягйхпшхтфецолимчьшпябрыэйрэвнчцкпюбмуфчьэтзютшьцуйалбшмздюшзоцын
оикяиогянтшашыалфшътнвыфэггтшнпэчякгмткбуьпшхьсдзяюъмщачййчуыогфхочпяцуоььшврчшнчббуэлзаъмтюысмыц
хнблйчппъчцмфачуоььчьйачппаюпязшщикньънлзбыцьчыъмтднсчвькпошщктмацхпгборерыъссъщийжатшашрързэщхпле
шгльнорялнньетмявсушнныеиъебхывбымяръюъпауьбйкыщордхяпдаеубеюзикрогпгбъьгоущиюхэичшышхкшчцорюхяпе
эшчъцощахъхцьгшършялъннфсцыфяшчитэячдыщиьщгтцоэзсссфаньжбхкзшьрнядыяффбыккпшфйчтщчэдъкывлуэнъыеъ
едпщьдмьчяэлхсшеекщщчьшулъэышхгкзэькэяньыушешлнеьуыепомыбфдьрлмочвьдыфмщгяьячьшоонянйцгкзэмжфйрсч
ифцдпыэырстдгыцлнуыьяыушнягпньщжоьоьофвяэюзмьчпащььщегфхочвшфювщьэтыаьцъздмупшыъсматзмяшчцвфьюо
патхпжшхуочьфндъщнпжатснкыфцъяхьшдяеыемуэамъчцхькпяпмощийтдныжхкцлчьщебъсрьбшыщшвцюндбымофшьяь
ббоссфтхчвдьцечуырдуиккщечцяцуэтдяхкшцгпъвчцщиббэцыжгкыоьрсиняыхпшжвокпюмзтюънмвблюэрущидятфчщату
кпефскаънщвгйтлфысмдвнхпежгылыаиндфтячвдьклчьщесощитбшырвььщомчшцррычуеыафняцыфпбтоьипаслотюфэдае
чллъснпчьутюуццйпфруотэхпахшезкгфддфхюпэжмйюпхъчйапеьвякнпчццфтьылшцбъципушикнцчпдхечлщйюппапцоью
трмшсьеачпъеетбояшясмыгыъщуежтвынюпдвпццчбобмшаъмбаощпдхкалъцфпндыфщвчфбмшщъмотъъпвактитымкяянъ
кмшыащоуэясгтфжашьюлмрссвъэроцуодэькоорчщдфьюшыэфьщехфягыуккрлыушьраячйжпоуойаыясащчшшхпжвчаятбе
щнчрлпыкшъшаркяилщэкыэьэьоссъыьлшъудчцтнэрдиыжпсойфоэвнцнисфкпъкктъчсаогшбфшщпкщэягачиспхкупыноря
лтхтщъпъитэъсйашдфзешезкшьеоэтхтуапэлорфжмтнчшлшцблчощеоасктъакэлььшуцдыъшлэкявуемсюдтйпвфдночмоцдя
яшкяпчьжььгкдэлйшэешезпымхнцмбпэдйянптфдперряцыоцйегюоцччкшхмпъъььяждятьтыыбуофолтнйчикюуфпшнуъмд
дэрбщдфоьтазедятфшъшвкяттстыбыъшажбалэысемчячхвмктекаъуцчрцчщещщлгоримчщцрщещунпшъсздйщйбымщвмьщиббэимватшяпюбумъчхтыжщьъььшунянхпцгкзэпаэярэтмтмппяитбюоцьххпжвхьцктфомтънцвщпамшръряйхккжпыняш
шьувгтййзапукпайтнхыщкабньопплннпяиьвкфоккхсмкчнппаюйрвъафтрсфнцятмуньцюсютяцбюучуяпююисгмфшъшвкк
прсрздйныяычукъооисгмзыббцывфоцодцтушбшыеэыащаюъщньракташщъвнытмтбдьрвчыяюрднйтяпчбыбоэтзиафтдуьь
ктягелятщъфхчцйшугтнятчшшхпюгпыъппачуйжыиьюгупоачритектаэькгтнпяцчщшповньрекапщхщчсоъьцшчдднчшмюк
эншеиомаохтауйяяшчэпптпцббыфьпэефвчъцннвжоцяхнюьрсыхкцбхьфкяооиаэлкбысъахббоиьюнъшйппепыфюачютшбш
былыафинунхтюуфывщйюаюгйпкюгпэеькопяюмътввеаъььхврдэнбьыяэвъръйзъвчшеюпткпчэегъъгцерчялюящебнюткыж
пъшцьщимчьихьакшлхущиочэнофюьонпъфссъъгйчюйтвхяонзюнхтщятяпъоболъщхпгбмунтщъсыйяцйюбщьюпщибнбэи
мцдпсбкжщидчрцоьзтюэцпзмясяхтюжйэнтрзкрбхщецуькккпссоэымчвшзяппаэтбафушюубуоьрснматтшжбъьвцурлдяъцъ
фъдубкщъевасывзылуоюььмдяъцпгшъуктъмлнжышцзшньппщмндщнфпжашэвъуцогъэыйьцъбяъумлыяыщьрщтхктьрняь
ыныяылуижпъбъэьшкцакяфпашаюдърффхпюлйащоняогхггкречоэчддпщпчбщюлбупозуиущяучцюещосдаобтэъкслмььиа
ншцщдумцижыъчсамцффъкщойхрероюннвччнккшмнтятупжапслщюътзфыщьвтчцьйшъпнутужхбчуоэъмсччсатэшцбмъь
этнбэрмщюшящмьордюмрндобунпхфгпеыъфдоькеыафнтцтушцешъфььэоовхякеечьоькноечютшажчуйшфстовымшящка
щынрокхыхпгбьювмьтибвнщызчшшпшсраюбыщьфгкщойьювдгярмыцхнбщюъскчурмфтобаэшътнвнзшжэкэеьучеивнщы
жумщвчызхоашыфджньйфьчомяаэшшыхомштыипттфкуцэюпкъфсбасифююиерщьотнвмзэябмшрыаьекодиьвькюзтбшеэл
тсшгшъупжялнябащьвеэршыжмярдтчпбпхцупъсрзспщьфетшвтбпобаэрьрэшщлчызчсаыхтвфйхэчйыифтядмцшъгнппьарф
ымкфгппнкъьарбхшкщяеъбкрчемътфсфяфоячбдисодъшхбчцмъцтилтшрфышцщвфьчомяихшехштвгубисвтншбтмщьпаэя
зфюнцьатевццырзйххшэыыщвояювзчщкпшычьйхцвенцъифвтцьйпыюакоъцщвайщфььътбаэибьхкащынътлтмъчьэкяятям
юшчрцывдмьбкцьажюиахуежрйпяюоьдылшвдмьбпаъждгнфшщкььдкюскядйщйвеъьбчццамаьрьрысцоььгнзьнэшддшплъ
оэемюншьщаоухкыэушчюъмвхкщитжибктрцофгйалцбгтнъщнхежгуоьръвяяхнмггшяикрчемътпкюбчойкнюнзьнфкуечцз
ыбеердпцмфюььижшъпндыфэлешяргуэтбапихебльнчуэбдшхажвелуофьщецяыщььвштрцочятцхшкуэоюрньхбдгчцчщкчь
оьцщетутшпъшвкойьюврдэнбьдььгоуэтбчъхеавеаэйяиоснюткжптылпэъппчухпажчульръдюхшисвефщыбоэоааэхшчбырл
оолсстшчйжыькойьюссеьиймунхэвополщнкъщяйэншжсдччтщцвяпыпкэьифасийшшьоижыъзяедрхдуыэлхьтемътпкяуоое
цьенъчщньфюхцфпяцидйтшпгуяцмкаьукъэцмфхвцвыаснъбыщьвтчылцолчзэхкэчюээлхнурдяхзщдбщнптрдироднъщъмуо
жысфгапэшшашчбмуьиюгъцмфбфодкщэяоасщпбписншхщыфбянъвчкшптщсйзщьшшцбхьзтцюрюбытсябмуцтгэтпччцсб
шмубшъъчычццфюжхкпчьхвнэтссфдхокчйбпнцьцьвюшшкпвмомъпгыжжщоитъстяжышкаысыэчцлзмтдрьщюжылльчедх
шылвэтъебушвдвызьббсойежчякцхмкюеъодцуэтзферуьимыэсцрасчшдчвьщьохуробтянхрашяптаьеочяичьшчоопшъмъзх
шпгетщеуъсзнщызкяюпслъцлбдгюяпжаегйтсьахъцфкуечцзкымдоапнъйашяпжмуелэхиъйбчаштхорялтхчпшзъэчовизаър
щьэтюлмочимтщнчуйпщьыкмрфчычьщгтшошрзмзьшжмфятоъъьыляяийъщцппипюфоьгъцнщютшлщасргрбцщвдпаеьучь
йаъщпдхкалъцлняечртжшяыефцопявхопггшчбйесрдщскшдхшявцымдхтяцнвхпшэтэъскчкъшчбчуофьчьйачцъьчшюлмрэт
тбнньцчъуячмкааунъыюжидвъшъвыфэнсфачбымпълдчъцмпьфьйщщскрщсичььщьбшпщосащыффэщювртсомтогхфблщв
щщснягыкыщиыалъьщссвынчьтццмъцъряднчъьхяьбпяьажеьнъщимопермесцаэшждьюэчыъгнгыжсфцшюкпчуаовтмпяпч
ьжыаьекодиьвдьцояаънзйтщфьяццншъыоеъэиьщюпчошщлрйъхфкыжьомшыфзтдмхпждйэншдссръмщкабяьбшрэалачиьв
хтээъьоыфпчрщфщпчомуьхтфхщйжхшхбэгъпктпиьщюжышпъмшзяичтвапюлмьрнзбэноашьйупщздперрпвфштнкызирдэ
нщфаернпъсндюхкыщбчцяцуэтдбэноеекмпщьрслчеичбоцуоьуэтбчъхеаызщвфаьицчюттадмупшъцайуамьвхщоптысвктчн
фвюхузацънмацктвюшыфпщфимармкебяюэчнстрсяцхрэшязпщстчтющтбумьншаырзфымшцыъбзшнюеиъюыхьечулщцэу
дюинщпефцпкшфвзцхажешлнмъццртйтхчпяаумйъфкьдыфэябрбльшьобчъхшеетрльрътняыапцшхккпаэяоацмпжэшээькю
внчщзывыъйпжялвеъшияшбщьичьпозйхщьвдпюбпещоваьштыакыей

    """
    # ^^^^
    # ЦЕ ПРИКЛАД! ЗАМІНІТЬ ЙОГО НА ВАШ ТЕКСТ.

    ciphertext = clean_text(ciphertext_raw)
    if not ciphertext:
        print("ПОМИЛКА: Шифртекст порожній.")
        return

    # --- Крок 1: Пошук довжини ключа 'r' ---
    # (Метод: IC розшифрованого тексту)
    print("Шукаю найкращу довжину ключа...")
    best_r = 0
    max_ic = -1.0

    for r in range(2, MAX_KEY_LENGTH_TO_CHECK + 1):
        probable_key = get_probable_key(ciphertext, r)
        plaintext_candidate = vigenere_decrypt(ciphertext, probable_key)
        ic = calculate_ic(plaintext_candidate)

        # Чим ближче IC до IC_LANGUAGE, тим краще
        if ic > max_ic:
            max_ic = ic
            best_r = r

    print(f"-> Знайдена довжина ключа (r): {best_r} (з IC = {max_ic:.4f})")

    # --- Крок 2: Отримання ключа та розшифрування ---
    final_key = get_probable_key(ciphertext, best_r)
    print(f"-> Знайдений ключ: {final_key}")

    plaintext = vigenere_decrypt(ciphertext, final_key)
    print(f"\nРозшифрований текст:\n{plaintext}\n")

    # --- Крок 3: Збереження ---
    output_content = (
        f"--- Результати криптоаналізу ---\n"
        f"Визначена довжина ключа (r): {best_r}\n"
        f"Використаний ключ: {final_key}\n"
        f"--- Розшифрований текст ---\n{plaintext}\n"
    )

    try:
        with open(OUTPUT_FILENAME, "w", encoding="utf-8") as f:
            f.write(output_content)
        print(f"Успіх! Результати збережено у файл '{OUTPUT_FILENAME}'.")
    except Exception as e:
        print(f"ПОМИЛКА при збереженні файлу: {e}")


if __name__ == "__main__":
    main()
